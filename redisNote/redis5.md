# redis的持久化机制  
持久化，即将数据保存到磁盘。redis以数据结构的形式将数据维持到内存中，为了让这些数据在redis重启后仍然可用，reids提供了AOF和RDB两种持久化模式。
redis提供了两种持久化机制：   
* AOF  追加，以协议文本的方式，将所有对数据库进行过写入命令（及其参数）记录到AOF文件，以此达到记录数据库状态的目的。    
* RDB  将数据库的快照以二进制的方式保存到磁盘中  

## AOF  
* 同步命令到AOF文件的整个过程可以分为三个阶段  
  * 命令传播  当一个redis客户端要执行命令时，它通过网络连接，将协议文本发送给redis服务器。服务器在接收到客户端请求后，会根据协议文本内容，选择适当的命令函数，将各个参数从字符串文本转换为redis字符串对象。当命令函数执行成功后，命令参数会传播到AOF程序。
  * 缓存追加  当命令传播到AOF程序后，程序会根据命令及命令的参数，将命令还原为redis网络通信协议（原来的协议文本）、再将协议文本追加到aof_buf末尾。  
  * 文件写入和保存  

## RDB  
* 在redis运行时，RDB程序将当前内存中的数据库快照保存到磁盘文件中，在redis重启动时，RDB程序可以通过载入RDB文件来还原数据库的状态。 
* redis功能最核心的rbdSave和rdbLoad两个函数，前者用于生成RDB文件到磁盘，后者用于将RDB文件中的数据重新载入到内存中。
### 保存
 * rdbSave负责将内存中的数据库数据以RDB的格式保存到磁盘中，如果RDB文件已经存在，那么新的RDB文件将替换已有的RDB文件。
 * 在保存RDB文件期间，主进程会被阻塞，知道保存完成为止  
 * SAVE和BGSAVE两个命令都会调用rdbSave函数，但调用方式不同
   * save直接调用rdbSave,阻塞主线程，知道保存完成为止。在主线程阻塞期间，服务器不能处理任何请求。 
   * BGSAVE则fork出一个子进程，子进程负责调用rdbSave,并在保存完成后向主线程发送信号，通知保存完成，因为是在子线程中调用的，所以主线程阻塞期间，服务器仍然可以处理请求。
 * RDB的文件结构  
  ![](https://github.com/FantasmYi/CodeMonkeyNote/blob/master/image/RDB.png)

  
